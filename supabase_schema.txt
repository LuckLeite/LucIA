
-- Script de Criação do Banco de Dados Flux (Protegido)
-- Rode isso no SQL Editor do Supabase

-- 1. Tabela de Categorias
CREATE TABLE IF NOT EXISTS categories (
  id TEXT PRIMARY KEY,
  user_id UUID DEFAULT auth.uid(),
  name TEXT NOT NULL,
  iconName TEXT NOT NULL,
  color TEXT NOT NULL,
  type TEXT NOT NULL CHECK (type IN ('income', 'expense')),
  includeInTithing BOOLEAN DEFAULT true,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

-- 2. Tabela de Transações
CREATE TABLE IF NOT EXISTS transactions (
  id TEXT PRIMARY KEY,
  user_id UUID DEFAULT auth.uid(),
  amount NUMERIC NOT NULL,
  type TEXT NOT NULL CHECK (type IN ('income', 'expense')),
  categoryId TEXT REFERENCES categories(id),
  date DATE NOT NULL,
  description TEXT,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

-- 3. Tabela de Transações Planejadas
CREATE TABLE IF NOT EXISTS planned_transactions (
  id TEXT PRIMARY KEY,
  user_id UUID DEFAULT auth.uid(),
  amount NUMERIC NOT NULL,
  type TEXT NOT NULL CHECK (type IN ('income', 'expense')),
  categoryId TEXT REFERENCES categories(id),
  description TEXT,
  dueDate DATE NOT NULL,
  status TEXT NOT NULL CHECK (status IN ('pending', 'paid')),
  isGenerated BOOLEAN DEFAULT false,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

-- 4. Tabela de Cartões (Compras Parceladas)
CREATE TABLE IF NOT EXISTS card_transactions (
  id TEXT PRIMARY KEY,
  user_id UUID DEFAULT auth.uid(),
  name TEXT NOT NULL,
  card TEXT NOT NULL,
  totalAmount NUMERIC NOT NULL,
  installments INTEGER NOT NULL,
  purchaseDate DATE NOT NULL,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

-- 5. Tabela de Investimentos
CREATE TABLE IF NOT EXISTS investments (
  id TEXT PRIMARY KEY,
  user_id UUID DEFAULT auth.uid(),
  name TEXT NOT NULL,
  type TEXT NOT NULL,
  amount NUMERIC NOT NULL,
  currentBalance NUMERIC NOT NULL,
  startDate DATE NOT NULL,
  liquidity TEXT,
  rateType TEXT,
  rateValue NUMERIC,
  categoryId TEXT,
  "group" TEXT DEFAULT 'Geral',
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

-- 6. Tabela de Orçamentos (Budgets)
CREATE TABLE IF NOT EXISTS budgets (
  id TEXT PRIMARY KEY,
  user_id UUID DEFAULT auth.uid(),
  categoryId TEXT REFERENCES categories(id),
  "limit" NUMERIC NOT NULL,
  period TEXT DEFAULT 'monthly',
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

-- 7. Tabela de Configurações
CREATE TABLE IF NOT EXISTS settings (
  id TEXT PRIMARY KEY,
  user_id UUID DEFAULT auth.uid(),
  calculateTithing BOOLEAN DEFAULT true,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

-- Habilitar Row Level Security (RLS)
ALTER TABLE categories ENABLE ROW LEVEL SECURITY;
ALTER TABLE transactions ENABLE ROW LEVEL SECURITY;
ALTER TABLE planned_transactions ENABLE ROW LEVEL SECURITY;
ALTER TABLE card_transactions ENABLE ROW LEVEL SECURITY;
ALTER TABLE investments ENABLE ROW LEVEL SECURITY;
ALTER TABLE budgets ENABLE ROW LEVEL SECURITY;
ALTER TABLE settings ENABLE ROW LEVEL SECURITY;

-- POLÍTICAS DE SEGURANÇA
DROP POLICY IF EXISTS "Users can only access their own categories" ON categories;
CREATE POLICY "Users can only access their own categories" ON categories FOR ALL USING (auth.uid() = user_id) WITH CHECK (auth.uid() = user_id);

DROP POLICY IF EXISTS "Users can only access their own transactions" ON transactions;
CREATE POLICY "Users can only access their own transactions" ON transactions FOR ALL USING (auth.uid() = user_id) WITH CHECK (auth.uid() = user_id);

DROP POLICY IF EXISTS "Users can only access their own planned_transactions" ON planned_transactions;
CREATE POLICY "Users can only access their own planned_transactions" ON planned_transactions FOR ALL USING (auth.uid() = user_id) WITH CHECK (auth.uid() = user_id);

DROP POLICY IF EXISTS "Users can only access their own card_transactions" ON card_transactions;
CREATE POLICY "Users can only access their own card_transactions" ON card_transactions FOR ALL USING (auth.uid() = user_id) WITH CHECK (auth.uid() = user_id);

DROP POLICY IF EXISTS "Users can only access their own investments" ON investments;
CREATE POLICY "Users can only access their own investments" ON investments FOR ALL USING (auth.uid() = user_id) WITH CHECK (auth.uid() = user_id);

DROP POLICY IF EXISTS "Users can only access their own budgets" ON budgets;
CREATE POLICY "Users can only access their own budgets" ON budgets FOR ALL USING (auth.uid() = user_id) WITH CHECK (auth.uid() = user_id);

DROP POLICY IF EXISTS "Users can only access their own settings" ON settings;
CREATE POLICY "Users can only access their own settings" ON settings FOR ALL USING (auth.uid() = user_id) WITH CHECK (auth.uid() = user_id);
